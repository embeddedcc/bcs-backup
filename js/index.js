/*! bcs-backup - v0.1.0 - 2014-11-29 */!function(){function a(a,b){var c={id:a,timer:[{},{},{},{}],state:[{},{},{},{},{},{},{},{}]};async.series([function(b){f.read("process/"+a).then(function(a){c.process=a,b()})},function(b){async.timesSeries(8,function(b,d){async.series([function(d){f.read("process/"+a+"/state/"+b).then(function(a){c.state[b].state=a,d()}).fail(function(){console.log("error fetching state"),d()})},function(d){var e="BCS-460"===f.type?["exit_conditions","output_controllers"]:["exit_conditions","output_controllers","boolean_outputs"];async.eachSeries(e,function(d,e){f.read("process/"+a+"/state/"+b+"/"+d).then(function(a){c.state[b][d]=a,e()}).fail(function(){console.log("error: api - "+d),e()})},d)}],function(){d()})},b)},function(b){async.timesSeries(4,function(b,d){f.read("process/"+a+"/timer/"+b).then(function(a){c.timer[b]=a,d()})},b)}],function(){b(c)})}function b(a){var b={};async.series([function(a){async.eachSeries(["device","system","network"],function(a,c){f.read(a).then(function(d){"network"===a&&(delete d.ip,delete d.mac),b[a]=d,c()})},a)},function(a){b.temp=[],async.timesSeries(f.probeCount,function(a,c){b.temp.push({}),f.read("temp/"+a).then(function(d){b.temp[a]=d,c()})},a)},function(a){b.din=[],async.timesSeries(f.inputCount,function(a,c){b.din.push({}),f.read("din/"+a).then(function(d){b.din[a]=d,c()})},a)},function(a){b.output=[],async.timesSeries(f.outputCount,function(a,c){b.output.push({}),f.read("output/"+a).then(function(d){b.output[a]=d,c()})},a)},function(a){b.pid=[],async.timesSeries(f.probeCount,function(a,c){b.pid.push({}),f.read("pid/"+a).then(function(d){b.pid[a]=d,c()})},a)},function(a){b.igniter=[],async.timesSeries(3,function(a,c){b.igniter.push({}),f.read("igniter/"+a).then(function(d){b.igniter[a]=d,c()})},a)},function(a){b.ladder=[],async.timesSeries(40,function(a,c){b.ladder.push({}),f.read("ladder/"+a).then(function(d){b.ladder[a]=d,c()})},a)}],function(){a(b)})}function c(a,b){var c=Object.create(Object.getPrototypeOf(a)),d=Object.getOwnPropertyNames(a);return d.forEach(function(d){if(b(d,a[d])){var e=Object.getOwnPropertyDescriptor(a,d);Object.defineProperty(c,d,e)}}),c}function d(a,b){async.series([function(b){async.eachSeries(["device","system"],function(b,c){f.write(b,a[b]).then(function(){c()}).fail(function(){console.log("failure writing api: "+b),c()})},b)},function(b){async.timesSeries(f.probeCount,function(b,d){var e;a.temp.length>b&&(e=c(a.temp[b],function(a){return-1===["temp","setpoint"].indexOf(a)}),f.write("temp/"+b,e).then(function(){d()}).fail(function(){console.log("failure writing temp: "+b),d()}))},b)},function(b){async.timesSeries(f.inputCount,function(b,d){var e;a.din.length>b&&(e=c(a.din[b],function(a){return"on"!==a}),f.write("din/"+b,e).then(function(){d()}).fail(function(){console.log("failure writing din: "+b),d()}))},b)},function(b){async.timesSeries(f.outputCount,function(b,d){var e;a.output.length>b&&(e=c(a.output[b],function(a){return"on"!==a}),f.write("output/"+b,e).then(function(){d()}).fail(function(){console.log("failure writing output: "+b),d()}))},b)},function(b){async.timesSeries(f.probeCount,function(b,c){a.pid.length>b&&f.write("pid/"+b,a.pid[b]).then(function(){c()}).fail(function(){console.log("failure writing PID: "+b),c()})},b)},function(b){async.timesSeries(3,function(b,c){f.write("igniter/"+b,a.igniter[b]).then(function(){c()}).fail(function(){console.log("failure writing igniter: "+b),c()})},b)},function(b){async.timesSeries(40,function(b,c){f.write("ladder/"+b,a.ladder[b]).then(function(){c()}).fail(function(){console.log("failure writing ladder: "+b),c()})},b)}],function(){b(a)})}function e(a,b,d){async.series([function(d){var e=c(b.process,function(a){return-1===["running","paused","states"].indexOf(a)});f.write("process/"+a,e).then(function(){d()}).fail(function(){console.log("failure writing process: "+a),d()})},function(c){async.timesSeries(8,function(c,d){async.series([function(d){f.write("process/"+a+"/state/"+c,b.state[c].state).then(function(){d()}).fail(function(){console.log("failure writing state: "+c),d()})},function(d){var e="BCS-460"===f.version?["exit_conditions","output_controllers"]:["exit_conditions","output_controllers","boolean_outputs"];async.eachSeries(e,function(d,e){f.write("process/"+a+"/state/"+c+"/"+d,b.state[c][d]).then(function(){e()}).fail(function(){console.log("failure writing api: "+d),e()})},function(){d()})}],d)},c)},function(d){var e;async.times(4,function(d,g){e=c(b.timer[d],function(a){return-1===["on","value","enabled"].indexOf(a)}),f.write("process/"+a+"/timer/"+d,e).then(function(){g()}).fail(function(){console.log("failure writing timer: "+d),g()})},d)}],function(){d()})}var f={},g=$("<select>",{"data-name":"processDest"});$(document).ready(function(){var c;$("[data-name=bcs]").on("change",function(a){$("#bcs").parent().removeClass("has-success").removeClass("has-error"),f=new BCS.Device(a.target.value),f.on("ready",function(){localStorage["bcs-backup.url"]=a.target.value,$("[data-name=bcs]").parent().addClass("has-success").removeClass("has-error"),$("button#backup").removeClass("disabled"),f.helpers.getProcesses().then(function(a){a.forEach(function(a,b){$("[data-name=process][data-id="+b+"]").parent().contents().filter(function(){return 3===this.nodeType}).first().replaceWith(a.name),g.append($("<option>",{value:b}).text(a.name))}),$("#backup-options").removeClass("hide")})}).on("notReady",function(){$("[data-name=bcs]").parent().addClass("has-error").removeClass("has-success"),$("#options").addClass("hide"),$("button").addClass("disabled")})}),$("[data-name=backupFile]").on("change",function(a){var b,d=a.target.files[0];b=new FileReader,b.addEventListener("load",function(a){if(c=JSON.parse(a.target.result),c.system&&c.system.device){if($("#restore-options").removeClass("hide"),$("#version-warning").siblings().remove(),c.system.device.type===f.type)$("#version-warning").addClass("hide"),$("[data-name=backupFile]").parent().addClass("has-success").removeClass("has-error").removeClass("has-warning");else{if(!c.system.device.type.match(/^BCS\-46/))return $("[data-name=backupFile]").parent().addClass("has-error").removeClass("has-warning").removeClass("has-success"),void $("#version-warning").addClass("hide");$("[data-name=backupFile]").parent().addClass("has-warning").removeClass("has-error").removeClass("has-success"),$("#version-warning").removeClass("hide")}c.system.system&&$("<label>",{"class":"checkbox"}).text("System Settings").append($("<input>",{type:"checkbox","data-name":"system",checked:"checked"})).appendTo($("#restore-options")),$("<div>",{"class":"restoreOption"}).append($("<span>").text("Backed Up Process")).append($("<span>",{"class":"pull-right"}).text("Process to Replace")).appendTo($("#restore-options")),c.processes.sort(function(a,b){return a.id-b.id}),c.processes.forEach(function(a,b){$("<div>",{"class":"restoreOption"}).append($("<label>",{"class":"checkbox"}).text(a.process.name).append($("<input>",{type:"checkbox","data-name":"process","data-id":b,checked:"checked"}))).append(g.clone().attr("data-id",b).val(a.id)).appendTo($("#restore-options"))}),$("button#restore").removeClass("disabled")}}),b.readAsText(d)}),localStorage["bcs-backup.url"]&&($("[data-name=bcs]").val(localStorage["bcs-backup.url"]),$("[data-name=bcs][data-tab=backup]").change()),$("button#restore").on("click",function(a){a.preventDefault();var b,f=$("#dialog .modal-body"),g=95/($("#restore-options [data-name=process]:checked").length+$("#restore-options [data-name=system]:checked").length);f.empty(),f.append($("#progress").html()),$("#dialog h4.modal-title").text("Restoring..."),$("#dialog").modal("show"),b=f.find(".progress-bar-success")[0],$(b).attr("aria-valuenow",5),$(b).css("width",$(b).attr("aria-valuenow")+"%"),async.series([function(a){$("#restore-options [data-name=system]:checked").length>0?d(c.system,function(){$(b).attr("aria-valuenow",parseFloat($(b).attr("aria-valuenow"))+g),$(b).css("width",$(b).attr("aria-valuenow")+"%"),a()}):a()},function(a){async.each($("#restore-options [data-name=process]:checked"),function(a,d){e($("[data-name=processDest][data-id="+a.dataset.id+"]").val(),c.processes[a.dataset.id],function(){$(b).attr("aria-valuenow",parseFloat($(b).attr("aria-valuenow"))+g),$(b).css("width",$(b).attr("aria-valuenow")+"%"),d()})},a)}],function(){$("#dialog").modal("hide")})}),$("button#backup").on("click",function(c){c.preventDefault();var d,e={processes:[],system:{}},g=95/($("#backup-options [data-name=process]:checked").length+1),h=$("#dialog .modal-body");h.empty(),h.append($("#progress").html()),$("#dialog h4.modal-title").text("Backing Up..."),$("#dialog").modal("show"),d=h.find(".progress-bar-success")[0],$(d).attr("aria-valuenow",5),$(d).css("width",$(d).attr("aria-valuenow")+"%"),async.series([function(b){async.each($("#backup-options [data-name=process]:checked"),function(b,c){a(b.dataset.id,function(a){e.processes.push(a),$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+g),$(d).css("width",$(d).attr("aria-valuenow")+"%"),c()})},b)},function(a){$("#backup-options [data-name=system]:checked").length>0?b(function(b){e.system=b,$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+g),$(d).css("width",$(d).attr("aria-valuenow")+"%"),a()}):f.read("device").then(function(b){e.system.device=b,$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+g),$(d).css("width",$(d).attr("aria-valuenow")+"%"),a()})}],function(){var a=new Blob([JSON.stringify(e)],{type:"text/plain;charset=utf-8"});saveAs(a,($("[data-name=fileName]").val()||"bcs-backup")+".json"),$("#dialog").modal("hide")})})})}();