/*! bcs-backup - v0.1.0 - 2014-04-09 */!function(){function a(a,b,c){var d={id:b,win:[{},{},{},{}],timer:[{},{},{},{}],state:[{},{},{},{},{},{},{},{}]};async.parallel([function(c){$.get(a.url+"/api/process/"+b,function(a){d.process=a,c()})},function(c){async.times(8,function(c,e){async.series([function(e){$.get(a.url+"/api/process/"+b+"/state/"+c,function(a){d.state[c].state=a,e()}).fail(function(){console.log("error fetching state"),e()})},function(e){var f="BCS-460"===a.version?["exit_conditions","output_controllers"]:["exit_conditions","output_controllers","boolean_outputs"];async.each(f,function(e,f){$.get(a.url+"/api/process/"+b+"/state/"+c+"/"+e,function(a){d.state[c][e]=a,f()}).fail(function(){console.log("error: api - "+e),f()})},e)}],function(){e()})},c)},function(c){async.times(4,function(c,e){$.get(a.url+"/api/process/"+b+"/win/"+c,function(a){delete a.value,d.win[c]=a,e()})},c)},function(c){async.times(4,function(c,e){$.get(a.url+"/api/process/"+b+"/timer/"+c,function(a){d.timer[c]=a,e()})},c)}],function(){c(d)})}function b(a,b){var c={};async.parallel([function(b){async.each(["device","system","network"],function(b,d){$.get(a.url+"/api/"+b,function(a){"network"===b&&(delete a.ip,delete a.mac),c[b]=a,d()})},b)},function(b){c.temp=[],async.times(a.probeCount,function(b,d){c.temp.push({}),$.get(a.url+"/api/temp/"+b,function(a){c.temp[b]=a,d()})},b)},function(b){c.din=[],async.times(a.inputCount,function(b,d){c.din.push({}),$.get(a.url+"/api/din/"+b,function(a){c.din[b]=a,d()})},b)},function(b){c.output=[],async.times(a.outputCount,function(b,d){c.output.push({}),$.get(a.url+"/api/output/"+b,function(a){c.output[b]=a,d()})},b)},function(b){c.pid=[],async.times(a.probeCount,function(b,d){c.pid.push({}),$.get(a.url+"/api/pid/"+b,function(a){c.pid[b]=a,d()})},b)},function(b){c.igniter=[],async.times(3,function(b,d){c.igniter.push({}),$.get(a.url+"/api/igniter/"+b,function(a){c.igniter[b]=a,d()})},b)},function(b){c.ladder=[],async.times(40,function(b,d){c.ladder.push({}),$.get(a.url+"/api/ladder/"+b,function(a){c.ladder[b]=a,d()})},b)}],function(){b(c)})}function c(a,b,c){async.parallel([function(c){async.each(["device","system","network"],function(c,d){$.post(a.url+"/api/"+c,JSON.stringify(b[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(c){async.times(a.probeCount,function(c,d){b.temp.length>c&&$.post(a.url+"/api/temp/"+c,JSON.stringify(b.temp[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(c){async.times(a.inputCount,function(c,d){b.din.length>c&&$.post(a.url+"/api/din/"+c,JSON.stringify(b.din[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(c){async.times(a.outputCount,function(c,d){b.output.length>c&&$.post(a.url+"/api/output/"+c,JSON.stringify(b.output[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(c){async.times(a.probeCount,function(c,d){b.pid.length>c&&$.post(a.url+"/api/pid/"+c,JSON.stringify(b.pid[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(c){async.times(3,function(c,d){$.post(a.url+"/api/igniter/"+c,JSON.stringify(b.igniter[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(c){async.times(40,function(c,d){$.post(a.url+"/api/ladder/"+c,JSON.stringify(b.ladder[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)}],function(){c(b)})}function d(a,b,c,d){async.parallel([function(d){$.post(a.url+"/api/process/"+b,JSON.stringify(c.process),function(){d()}).fail(function(){console.log("failure"),d()})},function(d){async.times(8,function(d,e){async.series([function(e){$.post(a.url+"/api/process/"+b+"/state/"+d,JSON.stringify(c.state[d].state),function(){e()}).fail(function(){console.log("failure"),e()})},function(e){var f="BCS-460"===a.version?["exit_conditions","output_controllers"]:["exit_conditions","output_controllers","boolean_outputs"];async.each(f,function(e,f){$.post(a.url+"/api/process/"+b+"/state/"+d+"/"+e,JSON.stringify(c.state[d][e]),function(){f()}).fail(function(){console.log("failure"),f()})},function(){e()})}],e)},d)},function(d){async.times(4,function(d,e){$.post(a.url+"/api/process/"+b+"/win/"+d,JSON.stringify(c.win[d]),function(){e()}).fail(function(){console.log("failure"),e()})},d)},function(d){async.times(4,function(d,e){$.post(a.url+"/api/process/"+b+"/timer/"+d,JSON.stringify(c.timer[d]),function(){e()}).fail(function(){console.log("failure"),e()})},d)}],function(){d()})}$(document).ready(function(){var e,f,g={version:null,url:null,get probeCount(){return"BCS-460"===this.version?4:8},get inputCount(){return"BCS-460"===this.version?4:8},get outputCount(){return"BCS-460"===this.version?6:18}};$("[data-name=bcs]").on("change",function(a){$.get(a.target.value+"/api/device",function(b){"4.0.0"===b.version?(g.version=b.type,g.url=a.target.value,localStorage["bcs-backup.url"]=g.url,$("[data-name=bcs]").parent().addClass("has-success").removeClass("has-error"),$("button#backup").removeClass("disabled"),e=[],async.times(8,function(b,c){$.get(a.target.value+"/api/process/"+b,function(a){e.push({id:b,name:a.name}),c()})},function(){e.sort(function(a,b){return a.id-b.id}),"backup"===a.target.dataset.tab&&(e.forEach(function(a){$("[data-name=process][data-id="+a.id+"]").parent().contents().filter(function(){return 3===this.nodeType}).first().replaceWith(a.name)}),$("#backup-options").removeClass("hide"))})):($("[data-name=bcs]").parent().addClass("has-error").removeClass("has-success"),$("#options").addClass("hide"),$("button").addClass("disabled"))}).fail(function(){$("[data-name=bcs]").parent().addClass("has-error").removeClass("has-success"),$("#backup-options").addClass("hide")})}),$("[data-name=backupFile]").on("change",function(a){var b,c=a.target.files[0];b=new FileReader,b.addEventListener("load",function(a){if(f=JSON.parse(a.target.result),f.system&&f.system.device){if($("#restore-options").removeClass("hide"),f.system.device.type===g.version)$("#version-warning").addClass("hide"),$("[data-name=backupFile]").parent().addClass("has-success").removeClass("has-error").removeClass("has-warning");else{if(!f.system.device.type.match(/^BCS\-46/))return $("[data-name=backupFile]").parent().addClass("has-error").removeClass("has-warning").removeClass("has-success"),void $("#version-warning").addClass("hide");$("[data-name=backupFile]").parent().addClass("has-warning").removeClass("has-error").removeClass("has-success"),$("#version-warning").removeClass("hide")}f.system.system&&$("<label>",{"class":"checkbox"}).text("System Settings").append($("<input>",{type:"checkbox","data-name":"system",checked:"checked"})).appendTo($("#restore-options"));var b=$("<select>",{"data-name":"processDest"});e.forEach(function(a){b.append($("<option>",{value:a.id}).text(a.name))}),$("<div>",{"class":"restoreOption"}).append($("<span>").text("Backed Up Process")).append($("<span>",{"class":"pull-right"}).text("Process to Replace")).appendTo($("#restore-options")),f.processes.forEach(function(a,c){$("<div>",{"class":"restoreOption"}).append($("<label>",{"class":"checkbox"}).text(a.process.name).append($("<input>",{type:"checkbox","data-name":"process","data-id":c,checked:"checked"}))).append(b.clone().attr("data-id",c).val(a.id)).appendTo($("#restore-options"))}),$("button#restore").removeClass("disabled")}}),b.readAsText(c)}),localStorage["bcs-backup.url"]&&($("[data-name=bcs]").val(localStorage["bcs-backup.url"]),$("[data-name=bcs][data-tab=backup]").change()),$("button#restore").on("click",function(a){a.preventDefault();var b,e=$("#dialog .modal-body"),h=95/($("#restore-options [data-name=process]:checked").length+$("#restore-options [data-name=system]:checked").length);e.empty(),e.append($("#progress").html()),$("#dialog h4.modal-title").text("Restoring..."),$("#dialog").modal("show"),b=e.find(".progress-bar-success")[0],$(b).attr("aria-valuenow",5),$(b).css("width",$(b).attr("aria-valuenow")+"%"),async.series([function(a){$("#restore-options [data-name=system]:checked").length>0?c(g,f.system,function(){$(b).attr("aria-valuenow",parseFloat($(b).attr("aria-valuenow"))+h),$(b).css("width",$(b).attr("aria-valuenow")+"%"),a()}):a()},function(a){async.each($("#restore-options [data-name=process]:checked"),function(a,c){d(g,$("[data-name=processDest][data-id="+a.dataset.id+"]").val(),f.processes[a.dataset.id],function(){$(b).attr("aria-valuenow",parseFloat($(b).attr("aria-valuenow"))+h),$(b).css("width",$(b).attr("aria-valuenow")+"%"),c()})},a)}],function(){$("#dialog").modal("hide")})}),$("button#backup").on("click",function(c){c.preventDefault();var d,e={processes:[],system:{}},f=95/($("#backup-options [data-name=process]:checked").length+1),h=$("#dialog .modal-body");h.empty(),h.append($("#progress").html()),$("#dialog h4.modal-title").text("Backing Up..."),$("#dialog").modal("show"),d=h.find(".progress-bar-success")[0],$(d).attr("aria-valuenow",5),$(d).css("width",$(d).attr("aria-valuenow")+"%"),async.series([function(b){async.each($("#backup-options [data-name=process]:checked"),function(b,c){a(g,b.dataset.id,function(a){e.processes.push(a),$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+f),$(d).css("width",$(d).attr("aria-valuenow")+"%"),c()})},b)},function(a){$("#backup-options [data-name=system]:checked").length>0?b(g,function(b){e.system=b,$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+f),$(d).css("width",$(d).attr("aria-valuenow")+"%"),a()}):$.get(g.url+"/api/device",function(b){e.system.device=b,$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+f),$(d).css("width",$(d).attr("aria-valuenow")+"%"),a()})}],function(){var a=new Blob([JSON.stringify(e)],{type:"text/plain;charset=utf-8"});saveAs(a,"bcs-backup.json"),$("#dialog").modal("hide")})})})}();