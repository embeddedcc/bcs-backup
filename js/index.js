/*! bcs-backup - v0.1.0 - 2014-10-05 */!function(){function a(a,b,c){var d={id:b,timer:[{},{},{},{}],state:[{},{},{},{},{},{},{},{}]};async.series([function(c){$.get(a.url+"/api/process/"+b,function(a){d.process=a,c()})},function(c){async.timesSeries(8,function(c,e){async.series([function(e){$.get(a.url+"/api/process/"+b+"/state/"+c,function(a){d.state[c].state=a,e()}).fail(function(){console.log("error fetching state"),e()})},function(e){var f="BCS-460"===a.version?["exit_conditions","output_controllers"]:["exit_conditions","output_controllers","boolean_outputs"];async.eachSeries(f,function(e,f){$.get(a.url+"/api/process/"+b+"/state/"+c+"/"+e,function(a){d.state[c][e]=a,f()}).fail(function(){console.log("error: api - "+e),f()})},e)}],function(){e()})},c)},function(c){async.timesSeries(4,function(c,e){$.get(a.url+"/api/process/"+b+"/timer/"+c,function(a){d.timer[c]=a,e()})},c)}],function(){c(d)})}function b(a,b){var c={};async.series([function(b){async.eachSeries(["device","system","network"],function(b,d){$.get(a.url+"/api/"+b,function(a){"network"===b&&(delete a.ip,delete a.mac),c[b]=a,d()})},b)},function(b){c.temp=[],async.timesSeries(a.probeCount,function(b,d){c.temp.push({}),$.get(a.url+"/api/temp/"+b,function(a){c.temp[b]=a,d()})},b)},function(b){c.din=[],async.timesSeries(a.inputCount,function(b,d){c.din.push({}),$.get(a.url+"/api/din/"+b,function(a){c.din[b]=a,d()})},b)},function(b){c.output=[],async.timesSeries(a.outputCount,function(b,d){c.output.push({}),$.get(a.url+"/api/output/"+b,function(a){c.output[b]=a,d()})},b)},function(b){c.pid=[],async.timesSeries(a.probeCount,function(b,d){c.pid.push({}),$.get(a.url+"/api/pid/"+b,function(a){c.pid[b]=a,d()})},b)},function(b){c.igniter=[],async.timesSeries(3,function(b,d){c.igniter.push({}),$.get(a.url+"/api/igniter/"+b,function(a){c.igniter[b]=a,d()})},b)},function(b){c.ladder=[],async.timesSeries(40,function(b,d){c.ladder.push({}),$.get(a.url+"/api/ladder/"+b,function(a){c.ladder[b]=a,d()})},b)}],function(){b(c)})}function c(a,b){var c=Object.create(Object.getPrototypeOf(a)),d=Object.getOwnPropertyNames(a);return d.forEach(function(d){if(b(d,a[d])){var e=Object.getOwnPropertyDescriptor(a,d);Object.defineProperty(c,d,e)}}),c}function d(a,b,d){async.series([function(c){async.eachSeries(["device","system"],function(c,d){$.post(a.url+"/api/"+c,JSON.stringify(b[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(d){async.timesSeries(a.probeCount,function(d,e){var f;b.temp.length>d&&(f=c(b.temp[d],function(a){return-1===["temp","setpoint"].indexOf(a)}),$.post(a.url+"/api/temp/"+d,JSON.stringify(f),function(){e()}).fail(function(){console.log("failure"),e()}))},d)},function(d){async.timesSeries(a.inputCount,function(d,e){var f;b.din.length>d&&(f=c(b.din[d],function(a){return"on"!==a}),$.post(a.url+"/api/din/"+d,JSON.stringify(f),function(){e()}).fail(function(){console.log("failure"),e()}))},d)},function(d){async.timesSeries(a.outputCount,function(d,e){var f;b.output.length>d&&(f=c(b.output[d],function(a){return"on"!==a}),$.post(a.url+"/api/output/"+d,JSON.stringify(f),function(){e()}).fail(function(){console.log("failure"),e()}))},d)},function(c){async.timesSeries(a.probeCount,function(c,d){b.pid.length>c&&$.post(a.url+"/api/pid/"+c,JSON.stringify(b.pid[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(c){async.timesSeries(3,function(c,d){$.post(a.url+"/api/igniter/"+c,JSON.stringify(b.igniter[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)},function(c){async.timesSeries(40,function(c,d){$.post(a.url+"/api/ladder/"+c,JSON.stringify(b.ladder[c]),function(){d()}).fail(function(){console.log("failure"),d()})},c)}],function(){d(b)})}function e(a,b,d,e){async.series([function(e){var f=c(d.process,function(a){return-1===["running","paused","states"].indexOf(a)});$.post(a.url+"/api/process/"+b,JSON.stringify(f),function(){e()}).fail(function(){console.log("failure"),e()})},function(c){async.timesSeries(8,function(c,e){async.series([function(e){$.post(a.url+"/api/process/"+b+"/state/"+c,JSON.stringify(d.state[c].state),function(){e()}).fail(function(){console.log("failure"),e()})},function(e){var f="BCS-460"===a.version?["exit_conditions","output_controllers"]:["exit_conditions","output_controllers","boolean_outputs"];async.eachSeries(f,function(e,f){$.post(a.url+"/api/process/"+b+"/state/"+c+"/"+e,JSON.stringify(d.state[c][e]),function(){f()}).fail(function(){console.log("failure"),f()})},function(){e()})}],e)},c)},function(e){var f;async.times(4,function(e,g){f=c(d.timer[e],function(a){return-1===["on","value","enabled"].indexOf(a)}),$.post(a.url+"/api/process/"+b+"/timer/"+e,JSON.stringify(f),function(){g()}).fail(function(){console.log("failure"),g()})},e)}],function(){e()})}$(document).ready(function(){var c,f,g={version:null,url:null,get probeCount(){return"BCS-460"===this.version?4:8},get inputCount(){return"BCS-460"===this.version?4:8},get outputCount(){return"BCS-460"===this.version?6:18}};$("[data-name=bcs]").on("change",function(a){$("#bcs").parent().removeClass("has-success").removeClass("has-error"),$.get(a.target.value+"/api/device",function(b){"4.0.0"===b.version?(g.version=b.type,g.url=a.target.value,localStorage["bcs-backup.url"]=g.url,$("[data-name=bcs]").parent().addClass("has-success").removeClass("has-error"),$("button#backup").removeClass("disabled"),c=[],async.timesSeries(8,function(b,d){$.get(a.target.value+"/api/process/"+b,function(a){c.push({id:b,name:a.name}),d()})},function(){c.sort(function(a,b){return a.id-b.id}),"backup"===a.target.dataset.tab&&(c.forEach(function(a){$("[data-name=process][data-id="+a.id+"]").parent().contents().filter(function(){return 3===this.nodeType}).first().replaceWith(a.name)}),$("#backup-options").removeClass("hide"))})):($("[data-name=bcs]").parent().addClass("has-error").removeClass("has-success"),$("#options").addClass("hide"),$("button").addClass("disabled"))}).fail(function(){$("[data-name=bcs]").parent().addClass("has-error").removeClass("has-success"),$("#backup-options").addClass("hide")})}),$("[data-name=backupFile]").on("change",function(a){var b,d=a.target.files[0];b=new FileReader,b.addEventListener("load",function(a){if(f=JSON.parse(a.target.result),f.system&&f.system.device){if($("#restore-options").removeClass("hide"),$("#version-warning").siblings().remove(),f.system.device.type===g.version)$("#version-warning").addClass("hide"),$("[data-name=backupFile]").parent().addClass("has-success").removeClass("has-error").removeClass("has-warning");else{if(!f.system.device.type.match(/^BCS\-46/))return $("[data-name=backupFile]").parent().addClass("has-error").removeClass("has-warning").removeClass("has-success"),void $("#version-warning").addClass("hide");$("[data-name=backupFile]").parent().addClass("has-warning").removeClass("has-error").removeClass("has-success"),$("#version-warning").removeClass("hide")}f.system.system&&$("<label>",{"class":"checkbox"}).text("System Settings").append($("<input>",{type:"checkbox","data-name":"system",checked:"checked"})).appendTo($("#restore-options"));var b=$("<select>",{"data-name":"processDest"});c.forEach(function(a){b.append($("<option>",{value:a.id}).text(a.name))}),$("<div>",{"class":"restoreOption"}).append($("<span>").text("Backed Up Process")).append($("<span>",{"class":"pull-right"}).text("Process to Replace")).appendTo($("#restore-options")),f.processes.forEach(function(a,c){$("<div>",{"class":"restoreOption"}).append($("<label>",{"class":"checkbox"}).text(a.process.name).append($("<input>",{type:"checkbox","data-name":"process","data-id":c,checked:"checked"}))).append(b.clone().attr("data-id",c).val(a.id)).appendTo($("#restore-options"))}),$("button#restore").removeClass("disabled")}}),b.readAsText(d)}),localStorage["bcs-backup.url"]&&($("[data-name=bcs]").val(localStorage["bcs-backup.url"]),$("[data-name=bcs][data-tab=backup]").change()),$("button#restore").on("click",function(a){a.preventDefault();var b,c=$("#dialog .modal-body"),h=95/($("#restore-options [data-name=process]:checked").length+$("#restore-options [data-name=system]:checked").length);c.empty(),c.append($("#progress").html()),$("#dialog h4.modal-title").text("Restoring..."),$("#dialog").modal("show"),b=c.find(".progress-bar-success")[0],$(b).attr("aria-valuenow",5),$(b).css("width",$(b).attr("aria-valuenow")+"%"),async.series([function(a){$("#restore-options [data-name=system]:checked").length>0?d(g,f.system,function(){$(b).attr("aria-valuenow",parseFloat($(b).attr("aria-valuenow"))+h),$(b).css("width",$(b).attr("aria-valuenow")+"%"),a()}):a()},function(a){async.each($("#restore-options [data-name=process]:checked"),function(a,c){e(g,$("[data-name=processDest][data-id="+a.dataset.id+"]").val(),f.processes[a.dataset.id],function(){$(b).attr("aria-valuenow",parseFloat($(b).attr("aria-valuenow"))+h),$(b).css("width",$(b).attr("aria-valuenow")+"%"),c()})},a)}],function(){$("#dialog").modal("hide")})}),$("button#backup").on("click",function(c){c.preventDefault();var d,e={processes:[],system:{}},f=95/($("#backup-options [data-name=process]:checked").length+1),h=$("#dialog .modal-body");h.empty(),h.append($("#progress").html()),$("#dialog h4.modal-title").text("Backing Up..."),$("#dialog").modal("show"),d=h.find(".progress-bar-success")[0],$(d).attr("aria-valuenow",5),$(d).css("width",$(d).attr("aria-valuenow")+"%"),async.series([function(b){async.each($("#backup-options [data-name=process]:checked"),function(b,c){a(g,b.dataset.id,function(a){e.processes.push(a),$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+f),$(d).css("width",$(d).attr("aria-valuenow")+"%"),c()})},b)},function(a){$("#backup-options [data-name=system]:checked").length>0?b(g,function(b){e.system=b,$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+f),$(d).css("width",$(d).attr("aria-valuenow")+"%"),a()}):$.get(g.url+"/api/device",function(b){e.system.device=b,$(d).attr("aria-valuenow",parseFloat($(d).attr("aria-valuenow"))+f),$(d).css("width",$(d).attr("aria-valuenow")+"%"),a()})}],function(){var a=new Blob([JSON.stringify(e)],{type:"text/plain;charset=utf-8"});saveAs(a,"bcs-backup.json"),$("#dialog").modal("hide")})})})}();